version: '3.8'

services:
  weather-bot:
    build: .
    image: peramos-weather-bot:latest
    container_name: weather-bot
    restart: unless-stopped
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'          # 50% of one CPU core
          memory: 128M         # Maximum 128MB RAM
          pids: 50            # Maximum 50 processes
        reservations:
          cpus: '0.1'         # Guarantee at least 10% CPU
          memory: 64M         # Guarantee at least 64MB RAM
    
    # Memory and OOM settings
    mem_limit: 128m           # Hard memory limit
    mem_reservation: 64m      # Soft memory limit
    memswap_limit: 256m      # Total memory + swap limit
    oom_kill_disable: false   # Allow OOM killer if needed
    
    # CPU settings
    cpu_shares: 512          # Relative CPU weight (default is 1024)
    cpu_quota: 50000         # Microseconds of CPU time per period
    cpu_period: 100000       # Period length in microseconds
    
    # I/O limits
    blkio_config:
      weight: 500            # I/O weight (10-1000, default 500)
      device_read_bps:
        - path: /dev/sda
          rate: 10mb         # Max 10MB/s read
      device_write_bps:
        - path: /dev/sda
          rate: 10mb         # Max 10MB/s write
    
    # Network limits (if using custom network)
    # networks:
    #   default:
    #     priority: 100      # Network priority
    
    # Environment variables
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      # Python memory optimizations
      - PYTHONMALLOC=malloc    # Use system malloc
      - MALLOC_TRIM_THRESHOLD_=100000  # Trim memory more aggressively
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import psutil, sys; sys.exit(0 if psutil.Process().memory_info().rss < 134217728 else 1)"]
      interval: 2m
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: false          # App needs to write logs
    tmpfs:
      - /tmp:size=10M        # Limit temp storage

# Optional: Define network with limits
# networks:
#   default:
#     driver: bridge
#     driver_opts:
#       com.docker.network.driver.mtu: 1450